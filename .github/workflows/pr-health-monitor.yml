name: üè• PR Health Monitor

on:
  schedule:
    # Run daily at 9 AM UTC
    - cron: '0 9 * * *'
  workflow_dispatch:
  pull_request:
    types: [opened, reopened]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  analyze-pr-health:
    runs-on: ubuntu-latest
    name: Analyze Repository PR Health
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run PR Health Analysis
        id: health-check
        run: |
          # Save output to file for later use
          node scripts/analyze-pr-health.js --save > /tmp/health-report.txt || true
          
          # Extract health score
          if [ -f "reports/pr-health-$(date +%Y-%m-%d).json" ]; then
            health_score=$(jq -r '.healthScore' reports/pr-health-$(date +%Y-%m-%d).json)
            echo "health_score=$health_score" >> $GITHUB_OUTPUT
          else
            echo "health_score=100" >> $GITHUB_OUTPUT
          fi
          
          cat /tmp/health-report.txt

      - name: Post Health Report Comment
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportFile = `reports/pr-health-${new Date().toISOString().split('T')[0]}.json`;
            
            let report = { stats: {}, healthScore: 100 };
            try {
              report = JSON.parse(fs.readFileSync(reportFile, 'utf8'));
            } catch (e) {
              console.log('No report file found');
            }

            const healthEmoji = report.healthScore >= 90 ? 'üü¢' : 
                               report.healthScore >= 70 ? 'üü°' : 
                               report.healthScore >= 50 ? 'üü†' : 'üî¥';

            const body = `## ${healthEmoji} Daily PR Health Report

            **Health Score:** ${report.healthScore}/100

            ### Summary
            - Total Open PRs: ${report.stats?.total || 0}
            - ‚úÖ Healthy: ${report.stats?.healthy || 0}
            - ‚ö†Ô∏è Aging (7-30 days): ${report.stats?.aging || 0}
            - üî¥ Stale (>30 days): ${report.stats?.stale || 0}
            - üö´ Blocked: ${report.stats?.blocked || 0}
            - üìù Draft: ${report.stats?.draft || 0}

            ### Recommendations
            ${report.stats?.stale > 0 ? `- Review and close or update ${report.stats.stale} stale PR(s)` : ''}
            ${report.stats?.aging > 0 ? `- Follow up on ${report.stats.aging} aging PR(s)` : ''}
            ${report.stats?.blocked > 0 ? `- Resolve conflicts in ${report.stats.blocked} blocked PR(s)` : ''}
            ${report.stats?.healthy === report.stats?.total ? '‚úÖ All PRs are in good health!' : ''}

            üìä See [PR Health Guide](../blob/main/docs/PR-HEALTH-GUIDE.md) for detailed information.

            ---
            *Generated by BSU Integrity Agent on ${new Date().toISOString().split('T')[0]}*
            `;

            // Create or update issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'pr-health-report'
            });

            if (issues.data.length > 0) {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body
              });
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `üìä PR Health Report - ${new Date().toISOString().split('T')[0]}`,
                body,
                labels: ['pr-health-report', 'automation']
              });
            }

      - name: Upload Report Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pr-health-report
          path: reports/pr-health-*.json
          retention-days: 30

      - name: Check Health Threshold
        if: steps.health-check.outputs.health_score != ''
        run: |
          health_score=${{ steps.health-check.outputs.health_score }}
          echo "Health Score: $health_score"
          
          if [ "$health_score" -lt 50 ]; then
            echo "‚ö†Ô∏è Critical: Health score below 50!"
            exit 1
          elif [ "$health_score" -lt 70 ]; then
            echo "‚ö†Ô∏è Warning: Health score below 70"
          else
            echo "‚úÖ Health score is acceptable"
          fi
