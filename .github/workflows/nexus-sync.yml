name: Nexus Sync

permissions:
  contents: write
  id-token: write

on:
  push:
    branches: [main]
    paths:
      - 'dns/**'
      - 'agents/**'
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

env:
  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
  CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests cloudflare

      - name: Run DNS Verification
        run: python agents/autonomous_sync_agent.py
        env:
          CF_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CF_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}

      - name: Commit changes
        if: success()
        run: |
          git config user.name "BSM-Agent"
          git config user.email "agent@lexdo.uk"
          git add .
          if ! git diff --quiet --cached; then
            git commit -m "Sync: DNS verification passed [skip ci]"
            git push
          fi
