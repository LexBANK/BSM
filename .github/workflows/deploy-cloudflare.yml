name: Deploy Cloudflare Infrastructure

on:
  push:
    branches:
      - main
    paths:
      - 'workers/**'
      - 'app/**'
      - 'scripts/deploy-*.sh'
      - '.github/workflows/deploy-cloudflare.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
          - development

jobs:
  # Job 1: Security checks
  security-check:
    name: Security & Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for exposed secrets in frontend
        run: |
          echo "üîç Checking for exposed secrets..."
          
          SECRET_PATTERNS=(
            "OPENAI.*KEY"
            "API.*KEY"
            "SECRET"
            "PRIVATE.*KEY"
            "TOKEN"
          )
          
          FOUND=0
          for pattern in "${SECRET_PATTERNS[@]}"; do
            if grep -rE "$pattern" app/ workers/ 2>/dev/null | grep -v "API_ENDPOINT" | grep -v "example" | grep -v "\.md:" > /dev/null; then
              echo "‚ö†Ô∏è  Warning: Potential secret pattern found: $pattern"
              FOUND=1
            fi
          done
          
          if [ $FOUND -eq 1 ]; then
            echo "‚ùå Potential secrets detected! Please review."
            exit 1
          fi
          
          echo "‚úÖ No secrets detected in code"

      - name: Validate CORS configuration
        run: |
          echo "üîç Validating CORS settings..."
          
          # Check that CORS is properly configured
          if grep -q "ALLOWED_ORIGINS" workers/lexchat/wrangler.toml; then
            echo "‚úÖ CORS configuration found"
          else
            echo "‚ö†Ô∏è  Warning: CORS configuration not found"
          fi

  # Job 2: Deploy Worker
  deploy-worker:
    name: Deploy LexChat Worker
    needs: security-check
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    environment:
      name: ${{ github.event.inputs.environment || 'production' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'workers/lexchat/package.json'

      - name: Install dependencies
        run: |
          cd workers/lexchat
          npm install

      - name: Deploy to Cloudflare Workers
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          cd workers/lexchat
          
          ENV="${{ github.event.inputs.environment || 'production' }}"
          
          if [ "$ENV" = "production" ]; then
            npx wrangler deploy --env production --name lexchat
          elif [ "$ENV" = "staging" ]; then
            npx wrangler deploy --env staging --name lexchat-staging
          else
            npx wrangler deploy --env development --name lexchat-dev
          fi

      - name: Verify deployment
        run: |
          echo "‚úÖ Worker deployed successfully!"
          
          if [ "${{ github.event.inputs.environment || 'production' }}" = "production" ]; then
            echo "üåê Worker URL: https://lexchat.moteb.uk"
          fi

  # Job 3: Deploy Pages
  deploy-pages:
    name: Deploy Cloudflare Pages
    needs: security-check
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Prepare app directory
        run: |
          ./scripts/deploy-pages.sh prepare

      - name: Deploy to Cloudflare Pages
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          npx wrangler pages deploy app \
            --project-name=lexdo \
            --branch=main \
            --commit-dirty=true

      - name: Verify deployment
        run: |
          echo "‚úÖ Pages deployed successfully!"
          echo "üåê Pages URL: https://lexdo.uk"

  # Job 4: Update Documentation
  update-docs:
    name: Update Documentation
    needs: [deploy-worker, deploy-pages]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Update reports and documentation
        env:
          CI: 'true'
        run: |
          ./scripts/auto-update-docs.sh

      - name: Commit documentation updates
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          
          git add docs/
          
          if ! git diff --staged --quiet; then
            git commit -m "docs: Auto-update deployment reports [skip ci]"
            git push
          else
            echo "No documentation changes to commit"
          fi

  # Job 5: Notify deployment status
  notify:
    name: Deployment Notification
    needs: [deploy-worker, deploy-pages, update-docs]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Check deployment status
        run: |
          echo "üìä Deployment Summary"
          echo "===================="
          echo "Worker: ${{ needs.deploy-worker.result }}"
          echo "Pages: ${{ needs.deploy-pages.result }}"
          echo "Docs: ${{ needs.update-docs.result }}"
          
          if [ "${{ needs.deploy-worker.result }}" = "success" ] && \
             [ "${{ needs.deploy-pages.result }}" = "success" ]; then
            echo "‚úÖ All deployments successful!"
            exit 0
          else
            echo "‚ùå Some deployments failed"
            exit 1
          fi
