name: Agent Deletion Guard

on:
  pull_request:
    branches: [main]
    paths:
      - 'data/agents/*.yaml'
      - 'data/agents/index.json'
      - '.github/workflows/agents-deletion-guard.yml'

jobs:
  block-agent-deletions:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect agent deletions
        shell: bash
        run: |
          set -euo pipefail

          BASE_REF="${{ github.base_ref }}"
          git fetch origin "${BASE_REF}" --depth=1

          DELETED_FILES=$(git diff --name-status "origin/${BASE_REF}...HEAD" | awk '$1=="D" {print $2}' | grep '^data/agents/.*\.yaml$' || true)

          if [ -n "$DELETED_FILES" ]; then
            echo "❌ Deleting agent files is blocked:" >&2
            echo "$DELETED_FILES" >&2
            echo "If this is intentional, require security/admin override outside this workflow." >&2
            exit 1
          fi

          if git diff --name-only "origin/${BASE_REF}...HEAD" | grep -q '^data/agents/index.json$'; then
            python - <<'PY'
import json
from pathlib import Path

idx = Path('data/agents/index.json')
obj = json.loads(idx.read_text(encoding='utf-8'))
agents = obj.get('agents', [])
if 'my-agent.yaml' not in agents:
    raise SystemExit('❌ index.json must include my-agent.yaml (critical agent).')
print('✅ index.json guard passed.')
PY
          fi

          echo "✅ No blocked agent deletions detected."
